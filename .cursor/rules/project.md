# KubernetesTest Project Rules

## Архитектура и принципы

### Общие принципы
- **SOLID принципы**: Следовать Single Responsibility, Open/Closed, Liskov Substitution, Interface Segregation, Dependency Inversion
- **DRY**: Избегать дублирования кода
- **YAGNI**: Не добавлять функциональность "на будущее"
- **Чистый код**: Читаемость, простота, минимализм

### Структура проекта
- **`pkg/`**: Переиспользуемые пакеты для всех микросервисов
- **`services/`**: Микросервисы (api-gateway, user-service, inventory-service, order-service, payment-service)
- **`proto/`**: Protobuf определения
- **`frontend/`**: React фронтенд

## Пакеты

### 1. Унифицированный логгер (`pkg/logger/`)
- **Интерфейс**: `Logger` с методами `Error`, `Warn`, `Info`, `Debug`
- **Реализация**: `ZapLogger` для *zap.SugaredLogger (удобный API)
- **Основа**: Zap SugaredLogger - золотой стандарт в Go логировании
- **Использование**: Все пакеты используют один интерфейс логгера

### 2. Redis клиент (`pkg/redisclient/`)
- **Архитектура**: Унифицированный клиент для кеша, токенов и списков
- **Методы**: `Set`, `Get`, `Del`, `Exists`, `Expire`, `LPush`, `RPush`, `LPop`, `RPop`, `LRange`, `LLen`, `MSet`, `MGet`
- **Токены**: `StoreToken`, `GetTokenUser`, `RevokeToken`, `RevokeAllUserTokens`, `IsTokenValid`
- **Оптимизации**: Pipeline операции, batch операции, индексы для пользователей
- **Логирование**: Через унифицированный интерфейс `logger.Logger`

### 3. Kafka (`pkg/kafka/`)
- **Consumer**: Worker pool с `RunValueLoop` и `RunMetaLoop`
- **Publisher**: Асинхронная публикация с подтверждением доставки
- **Конфигурация**: Структурированная через `ConsumerConfig` и `PublisherConfig`
- **Оптимизации**: Сжатие Snappy, батчинг, увеличенные буферы
- **Логирование**: Через унифицированный интерфейс `logger.Logger`

## Логирование

### Принципы
- **Единый интерфейс**: Все пакеты используют `logger.Logger`
- **Структурированное логирование**: Ключ-значение пары для контекста
- **Уровни**: `Error`, `Warn`, `Info`, `Debug`
- **Адаптеры**: Легко добавить новый логгер без изменения кода

### Использование
```go
// В микросервисах
log := logger.NewZapLogger(zapLogger.Sugar())

// В пакетах
redisClient := redisclient.New(addr, password, db, log)
kafkaConsumer := kafka.NewConsumer(config).WithLogger(log)
```

## Производительность

### Redis
- **Connection Pool**: `PoolSize: 20`, `MinIdleConns: 10`
- **Pipeline операции**: Для массовых операций с токенами
- **Индексы**: Пользовательские индексы для быстрого поиска токенов
- **Batch операции**: `MSet`, `MGet` для множественных ключей

### Kafka
- **Worker Pool**: Настраиваемое количество воркеров
- **Буферизация**: Увеличенные буферы для высокой пропускной способности
- **Сжатие**: Snappy для экономии трафика
- **Батчинг**: `linger.ms: 5` для группировки сообщений

## Обработка ошибок

### Принципы
- **Контекст**: Всегда добавлять контекст к ошибкам
- **Логирование**: Логировать все ошибки через унифицированный логгер
- **Graceful degradation**: Graceful shutdown для всех компонентов
- **Retry логика**: Настраиваемые повторные попытки

### Формат ошибок
```go
return fmt.Errorf("failed to %s: %w", operation, err)
```

## Тестирование

### Моки
- **Тестирование**: Используйте `logger.NewZapLogger(zap.NewNop().Sugar())` для тестов
- **Mock Redis**: Для unit тестов Redis операций
- **Mock Kafka**: Для тестирования producer/consumer

## Конфигурация

### Принципы
- **Структуры конфигурации**: Вместо множественных параметров
- **Значения по умолчанию**: Разумные дефолты для всех параметров
- **Валидация**: Проверка конфигурации при создании
- **Environment variables**: Через конфигурационные структуры

## Безопасность

### Redis
- **TTL**: Автоматическое истечение токенов
- **Изоляция**: Разные базы данных для разных сервисов
- **Аутентификация**: Поддержка паролей

### Kafka
- **Acknowledgment**: `acks: "all"` для надежности
- **Таймауты**: Настраиваемые таймауты для доставки
- **Graceful shutdown**: Корректное завершение работы

## Мониторинг и метрики

### Логирование
- **Структурированные логи**: JSON формат для анализа
- **Контекст**: Время выполнения, размер данных, количество операций
- **Трейсинг**: Worker ID для отслеживания обработки

### Метрики
- **Производительность**: Время выполнения операций
- **Ошибки**: Количество и типы ошибок
- **Пропускная способность**: Сообщений в секунду

## Развертывание

### Docker
- **Универсальный Dockerfile**: Один многоступенчатый Dockerfile для всех сервисов
- **Multi-stage builds**: Builder stage для компиляции, runtime stage для выполнения
- **Target-based builds**: `--target service-name` для сборки конкретного сервиса
- **Development stage**: Отдельный stage с Air для hot reload
- **Health checks**: Проверка готовности сервисов
- **Graceful shutdown**: Корректное завершение работы
- **Security**: Непривилегированный пользователь в runtime

### Kubernetes
- **Resource limits**: CPU и память для каждого сервиса
- **Liveness/Readiness**: Проверки состояния сервисов
- **Horizontal scaling**: Автоматическое масштабирование

## Разработка

### Код
- **Go 1.25**: Использовать современные возможности Go
- **Context**: Всегда использовать `context.Context` для отмены операций
- **Interfaces**: Минимальные интерфейсы, максимальная гибкость
- **Error handling**: Явная обработка всех ошибок

### Документация
- **Комментарии**: Только для публичных API
- **Примеры**: НЕ создавать файлы с примерами
- **README**: Только по запросу пользователя
